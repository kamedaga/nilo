<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nilo Browser Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #1e1e1e;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: #252526;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 16px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            color: #cccccc;
            font-weight: 600;
        }
        
        .file-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .file-item {
            padding: 8px 16px;
            color: #cccccc;
            cursor: pointer;
            transition: background 0.1s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-item:hover {
            background: #2a2d2e;
        }
        
        .file-item.active {
            background: #37373d;
            color: #ffffff;
        }
        
        .file-icon {
            font-size: 14px;
        }
        
        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            min-width: 0;
            min-height: 0;
            overflow: hidden;
        }
        
        .toolbar {
            height: 48px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 12px;
        }
        
        .toolbar-title {
            color: #cccccc;
            font-weight: 500;
            flex: 1;
        }
        
        .btn {
            padding: 6px 14px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #1177bb;
        }
        
        .btn-secondary {
            background: #3e3e42;
        }
        
        .btn-secondary:hover {
            background: #505050;
        }
        
        .editor-wrapper {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
            min-height: 0;
        }
        
        #editor {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        
        .divider {
            width: 4px;
            background: #3e3e42;
            cursor: col-resize;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        
        .divider:hover {
            background: #0e639c;
        }
        
        .preview-panel {
            flex: 1;
            background: white;
            position: relative;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }
        
        .preview-header {
            height: 36px;
            background: #f3f3f3;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            padding: 0 12px;
            color: #333;
            font-size: 13px;
            flex-shrink: 0;
        }
        
        #preview-container {
            flex: 1;
            overflow: auto;
            position: relative;
            min-height: 0;
        }
        
        .status-bar {
            height: 24px;
            background: #007acc;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 12px;
            gap: 16px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="sidebar">
            <div class="sidebar-header">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«</div>
            <div class="file-list" id="file-list">
                <div class="file-item active" data-file="app.nilo">
                    <span class="file-icon">ğŸ“„</span>
                    <span>app.nilo</span>
                </div>
                <div class="file-item" data-file="startup.nilo">
                    <span class="file-icon">ğŸ“„</span>
                    <span>startup.nilo</span>
                </div>
            </div>
        </div>
        
        <!-- ã‚¨ãƒ‡ã‚£ã‚¿ãƒ‘ãƒãƒ« -->
        <div class="editor-panel">
            <div class="toolbar">
                <span class="toolbar-title">ğŸš€ Nilo Browser Editor</span>
                <button class="btn" onclick="updatePreview()">â–¶ å®Ÿè¡Œ</button>
                <button class="btn-secondary btn" onclick="saveFile()">ğŸ’¾ ä¿å­˜</button>
                <button class="btn-secondary btn" onclick="resetFiles()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            
            <div class="editor-wrapper">
                <div id="editor"></div>
                <div class="divider" id="divider"></div>
                <div class="preview-panel">
                    <div class="preview-header">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                    <div id="preview-container">
                        <div id="container" style="width: 100%; min-height: 100%; position: relative;"></div>
                    </div>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="status-item">
                    <span id="status-text">ğŸ”¥ ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æœ‰åŠ¹</span>
                </div>
                <div class="status-item" id="file-name">app.nilo</div>
                <div class="status-item" id="auto-save-status">ğŸ’¾ è‡ªå‹•ä¿å­˜: ON</div>
            </div>
        </div>
    </div>

    <!-- Monaco Editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/editor/editor.main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    
    <script type="module">
        import init, { run_nilo_code_from_browser } from '/nilo.js';
        
        let editor;
        let currentFile = 'app.nilo';
        
        // LocalStorageã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆä¿å­˜ã•ã‚Œã¦ã„ã‚Œã°ï¼‰
        const loadFilesFromStorage = () => {
            const savedFiles = localStorage.getItem('nilo_files');
            if (savedFiles) {
                try {
                    return JSON.parse(savedFiles);
                } catch (e) {
                    console.error('Failed to load files from storage:', e);
                }
            }
            return null;
        };
        
        // LocalStorageã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
        const saveFilesToStorage = () => {
            try {
                localStorage.setItem('nilo_files', JSON.stringify(files));
                console.log('ğŸ’¾ Files auto-saved to LocalStorage');
            } catch (e) {
                console.error('Failed to save files to storage:', e);
            }
        };
        
        let files = loadFilesFromStorage() || {
            'app.nilo': `VStack(style: {
    width: 100ww,
    background: "#f5f5f5",
    padding: [20, 20],
    gap: 16px
}) {
    Text("Nilo ãƒ–ãƒ©ã‚¦ã‚¶ã‚¨ãƒ‡ã‚£ã‚¿", style: {
        font_size: 28px,
        color: "#333",
        font_weight: "bold"
    })
    
    Text("ã“ã“ã§ã‚³ãƒ¼ãƒ‰ã‚’ç·¨é›†ã§ãã¾ã™", style: {
        font_size: 16px,
        color: "#666"
    })
    
    Button(id: demo_btn, label: "ã‚¯ãƒªãƒƒã‚¯ï¼", style: {
        background: "#0e639c",
        color: "white",
        padding: [12, 24],
        border_radius: 6px,
        font_size: 14px
    })
}`,
            'startup.nilo': `flow {
    start: Welcome
}

timeline Welcome {
    VStack(style: {
        width: 100ww,
        background: "#1e1e1e",
        padding: [60, 40],
        align: "center"
    }) {
        Text("Nilo", style: {
            font_size: 64px,
            color: "#ffffff",
            font_weight: "bold"
        })
        
        Text("ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ãUIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯", style: {
            font_size: 20px,
            color: "#cccccc",
            margin_top: 16px
        })
    }
}`
        };
        
        // WASMåˆæœŸåŒ–
        console.log('ğŸ”§ Initializing WASM...');
        await init();
        console.log('âœ… WASM initialized');
        
        // Monaco EditoråˆæœŸåŒ–
        require.config({ 
            paths: { 
                'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' 
            } 
        });
        
        require(['vs/editor/editor.main'], function() {
            console.log('ğŸ¨ Monaco Editor loaded');
            
            // Niloè¨€èªç™»éŒ²
            monaco.languages.register({ id: 'nilo' });
            
            // ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆå®šç¾©
            monaco.languages.setMonarchTokensProvider('nilo', {
                keywords: [
                    'VStack', 'HStack', 'Text', 'Button', 'View', 'Section', 'Column', 'Row',
                    'flow', 'timeline', 'component', 'style', 'onclick', 'when',
                    'start', 'id', 'label', 'Spacing', 'Image', 'TextInput'
                ],
                
                tokenizer: {
                    root: [
                        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
                        [/[a-zA-Z_]\w*/, {
                            cases: {
                                '@keywords': 'keyword',
                                '@default': 'identifier'
                            }
                        }],
                        
                        // æ–‡å­—åˆ—
                        [/"([^"\\]|\\.)*$/, 'string.invalid'],
                        [/"/, 'string', '@string'],
                        
                        // æ•°å€¤
                        [/\d+px\b/, 'number.unit'],
                        [/\d+ww\b/, 'number.unit'],
                        [/\d+wh\b/, 'number.unit'],
                        [/\d+vw\b/, 'number.unit'],
                        [/\d+vh\b/, 'number.unit'],
                        [/\d+/, 'number'],
                        
                        // ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
                        [/#[0-9a-fA-F]{3,8}\b/, 'number.hex'],
                        
                        // ã‚³ãƒ¡ãƒ³ãƒˆ
                        [/\/\/.*$/, 'comment'],
                        
                        // æ‹¬å¼§
                        [/[{}()\[\]]/, '@brackets'],
                        
                        // ãƒ‡ãƒªãƒŸã‚¿
                        [/[,:]/, 'delimiter'],
                    ],
                    
                    string: [
                        [/[^\\"]+/, 'string'],
                        [/\\./, 'string.escape'],
                        [/"/, 'string', '@pop']
                    ],
                }
            });
            
            // ãƒ†ãƒ¼ãƒè¨­å®šï¼ˆNiloã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒï¼‰
            monaco.editor.defineTheme('nilo-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'keyword', foreground: '569CD6', fontStyle: 'bold' },
                    { token: 'string', foreground: 'CE9178' },
                    { token: 'number', foreground: 'B5CEA8' },
                    { token: 'number.hex', foreground: 'B5CEA8' },
                    { token: 'number.unit', foreground: 'B5CEA8' },
                    { token: 'comment', foreground: '6A9955', fontStyle: 'italic' },
                    { token: 'identifier', foreground: '9CDCFE' },
                ],
                colors: {
                    'editor.background': '#1e1e1e',
                }
            });
            
            // ã‚¨ãƒ‡ã‚£ã‚¿ä½œæˆ
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: files[currentFile],
                language: 'nilo',
                theme: 'nilo-dark',
                automaticLayout: true,
                minimap: { enabled: true },
                fontSize: 14,
                tabSize: 4,
                insertSpaces: true,
                wordWrap: 'on',
                lineNumbers: 'on',
                renderWhitespace: 'selection',
                scrollBeyondLastLine: false,
                folding: true,
                bracketPairColorization: {
                    enabled: true
                },
                suggestOnTriggerCharacters: true,
                quickSuggestions: true,
            });
            
            console.log('âœ… Editor created');
            
            // ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰: è‡ªå‹•ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–° + LocalStorageä¿å­˜
            let updateTimer;
            let saveTimer;
            editor.onDidChangeModelContent(() => {
                files[currentFile] = editor.getValue();
                
                // ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰: ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼ˆ500mså¾…æ©Ÿå¾Œã«æ›´æ–°ï¼‰
                clearTimeout(updateTimer);
                updateTimer = setTimeout(() => {
                    console.log('ï¿½ Hot reloading preview...');
                    updatePreview();
                }, 500);
                
                // LocalStorageã¸ã®è‡ªå‹•ä¿å­˜ï¼ˆ1ç§’å¾…æ©Ÿå¾Œï¼‰
                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => {
                    saveFilesToStorage();
                }, 1000);
            });
            
            // åˆå›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            updatePreview();
        });
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°é–¢æ•°
        window.updatePreview = function() {
            const startTime = performance.now();
            
            try {
                const code = files[currentFile];
                console.log(`ğŸ“ Rendering ${currentFile}...`);
                
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
                const previewContainer = document.getElementById('preview-container');
                const scrollTop = previewContainer.scrollTop;
                const scrollLeft = previewContainer.scrollLeft;
                
                // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢ã—ã¦å†ä½œæˆ
                previewContainer.innerHTML = '<div id="container" style="width: 100%; min-height: 100%; position: relative;"></div>';
                
                // WASMãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§Niloã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
                run_nilo_code_from_browser(code);
                
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒï¼ˆæ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§å®Ÿè¡Œï¼‰
                requestAnimationFrame(() => {
                    previewContainer.scrollTop = scrollTop;
                    previewContainer.scrollLeft = scrollLeft;
                });
                
                const elapsed = (performance.now() - startTime).toFixed(2);
                console.log(`âœ… Rendered in ${elapsed}ms`);
                
                document.getElementById('status-text').textContent = `ğŸ”¥ æ›´æ–°å®Œäº† (${elapsed}ms)`;
                setTimeout(() => {
                    document.getElementById('status-text').textContent = 'ğŸ”¥ ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æœ‰åŠ¹';
                }, 2000);
            } catch (error) {
                console.error('âŒ Preview error:', error);
                
                const errorHtml = `
                    <div style="padding: 20px; font-family: monospace;">
                        <h2 style="color: #d32f2f; margin-bottom: 16px;">ğŸš« ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
                        <div style="background: #ffebee; padding: 12px; border-left: 4px solid #d32f2f; border-radius: 4px;">
                            <strong>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong><br>
                            <pre style="margin: 8px 0; white-space: pre-wrap;">${error.message}</pre>
                        </div>
                        <div style="margin-top: 16px; color: #666;">
                            <strong>ãƒ’ãƒ³ãƒˆ:</strong> æ§‹æ–‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„
                        </div>
                    </div>
                `;
                
                document.getElementById('preview-container').innerHTML = errorHtml;
                document.getElementById('status-text').textContent = 'âŒ ã‚¨ãƒ©ãƒ¼';
            }
        };
        
        // ãƒ•ã‚¡ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆ - ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾å¿œ
        document.getElementById('file-list').addEventListener('click', (e) => {
            const fileItem = e.target.closest('.file-item');
            if (!fileItem) return;
            
            const filename = fileItem.dataset.file;
            if (filename === currentFile) return;
            
            console.log(`ğŸ“‚ Switching to ${filename}`);
            
            // ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
            if (editor) {
                files[currentFile] = editor.getValue();
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆ
            currentFile = filename;
            
            // UIæ›´æ–°
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });
            fileItem.classList.add('active');
            document.getElementById('file-name').textContent = filename;
            
            // ã‚¨ãƒ‡ã‚£ã‚¿æ›´æ–°ï¼ˆã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å…ˆé ­ã«ï¼‰
            if (editor) {
                editor.setValue(files[currentFile]);
                editor.setPosition({ lineNumber: 1, column: 1 });
                editor.focus();
            }
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å³åº§ã«æ›´æ–°
            updatePreview();
        });
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
        window.saveFile = function() {
            if (editor) {
                files[currentFile] = editor.getValue();
            }
            
            const blob = new Blob([files[currentFile]], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log(`ğŸ’¾ Saved ${currentFile}`);
            document.getElementById('status-text').textContent = `ğŸ’¾ ${currentFile} ã‚’ä¿å­˜ã—ã¾ã—ãŸ`;
            setTimeout(() => {
                document.getElementById('status-text').textContent = 'æº–å‚™å®Œäº†';
            }, 2000);
        };
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            // Ctrl+S / Cmd+S ã§ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveFile();
            }
            
            // Ctrl+Enter / Cmd+Enter ã§å³åº§ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                updatePreview();
            }
        });
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåˆæœŸçŠ¶æ…‹ã«æˆ»ã™ï¼‰
        window.resetFiles = function() {
            if (!confirm('ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆä¿å­˜ã—ã¦ã„ãªã„å¤‰æ›´ã¯å¤±ã‚ã‚Œã¾ã™ï¼‰')) {
                return;
            }
            
            localStorage.removeItem('nilo_files');
            location.reload();
        };
        
        // ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®åˆ†å‰²æ¯”ç‡ã‚’èª¿æ•´ï¼‰
        const divider = document.getElementById('divider');
        let isResizing = false;
        let lastX = 0;
        
        divider.addEventListener('mousedown', (e) => {
            isResizing = true;
            lastX = e.clientX;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            
            const container = document.querySelector('.editor-wrapper');
            const containerRect = container.getBoundingClientRect();
            const editorWidth = e.clientX - containerRect.left;
            const editorPercent = (editorWidth / containerRect.width) * 100;
            
            // æœ€å°20%ã€æœ€å¤§80%ã®åˆ¶é™
            if (editorPercent >= 20 && editorPercent <= 80) {
                const editorEl = document.getElementById('editor');
                const previewEl = document.querySelector('.preview-panel');
                
                editorEl.style.flex = `0 0 ${editorPercent}%`;
                previewEl.style.flex = `0 0 ${100 - editorPercent}%`;
                
                // Monaco Editorã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ›´æ–°
                if (editor) {
                    editor.layout();
                }
            }
        });
        
        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
                console.log('ğŸ“ Panel resize complete');
            }
        });
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ›´æ–°
        window.addEventListener('resize', () => {
            if (editor) {
                editor.layout();
            }
        });
        
        console.log('ğŸ‰ Nilo Browser Editor ready!');
        console.log('ğŸ“Œ Shortcuts:');
        console.log('   Ctrl+S / Cmd+S: ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜');
        console.log('   Ctrl+Enter / Cmd+Enter: å³åº§ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°');
    </script>
</body>
</html>
